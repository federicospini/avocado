// cli options
// -na caller port
// -nb peer port
// -sa storage location nodeA
// -sb storage location nodeB
// -w web3 provider
// -aa nodeA ETH account address
// -ab nodeB ETH account address

import minimist from 'minimist'
import path from 'path'
import request from 'request'
import p from 'es6-promisify'
import Web3 from 'web3'
import Contract from 'truffle-contract'
import fs from 'fs'
import solc from 'solc'

const argv = minimist(process.argv.slice(2))

const web3Provider = argv.w || 'http://localhost:8545'
const contractAddress = '0xa80ec6b07c97dcf6ca30e8eb80139e26990c8be0'
const abi = [{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"},{"name":"sequenceNumber","type":"uint256"},{"name":"state","type":"bytes"},{"name":"signature0","type":"bytes"},{"name":"signature1","type":"bytes"}],"name":"updateState","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"hash","type":"bytes32"},{"name":"sig","type":"bytes"},{"name":"signer","type":"address"}],"name":"ecverify","outputs":[{"name":"b","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"},{"name":"address0","type":"address"},{"name":"address1","type":"address"},{"name":"state","type":"bytes"},{"name":"challengePeriod","type":"uint256"},{"name":"signature0","type":"bytes"},{"name":"signature1","type":"bytes"}],"name":"newChannel","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"hash","type":"bytes32"},{"name":"sig","type":"bytes"}],"name":"ecrecovery","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"}],"name":"tryClose","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"inputChannelId","type":"bytes32"}],"name":"getChannel","outputs":[{"name":"channelId","type":"bytes32"},{"name":"address0","type":"address"},{"name":"address1","type":"address"},{"name":"phase","type":"uint8"},{"name":"challengePeriod","type":"uint256"},{"name":"closingBlock","type":"uint256"},{"name":"state","type":"bytes"},{"name":"sequenceNumber","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"},{"name":"signature","type":"bytes"},{"name":"signer","type":"address"}],"name":"startChallengePeriod","outputs":[],"payable":false,"type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"message","type":"string"}],"name":"Error","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"channelId","type":"bytes32"},{"indexed":false,"name":"address0","type":"address"},{"indexed":false,"name":"address1","type":"address"},{"indexed":false,"name":"phase","type":"uint8"},{"indexed":false,"name":"challengePeriod","type":"uint256"},{"indexed":false,"name":"closingBlock","type":"uint256"},{"indexed":false,"name":"state","type":"bytes"},{"indexed":false,"name":"sequenceNumber","type":"uint256"}],"name":"LogAcceptedChannel","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"channelId","type":"bytes32"},{"indexed":false,"name":"address0","type":"address"},{"indexed":false,"name":"address1","type":"address"},{"indexed":false,"name":"phase","type":"uint8"},{"indexed":false,"name":"challengePeriod","type":"uint256"},{"indexed":false,"name":"closingBlock","type":"uint256"},{"indexed":false,"name":"state","type":"bytes"},{"indexed":false,"name":"sequenceNumber","type":"uint256"}],"name":"LogPostedUpdate","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"channelId","type":"bytes32"},{"indexed":false,"name":"address0","type":"address"},{"indexed":false,"name":"address1","type":"address"},{"indexed":false,"name":"phase","type":"uint8"},{"indexed":false,"name":"challengePeriod","type":"uint256"},{"indexed":false,"name":"closingBlock","type":"uint256"},{"indexed":false,"name":"state","type":"bytes"},{"indexed":false,"name":"sequenceNumber","type":"uint256"}],"name":"LogStartedChallengePeriod","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"channelId","type":"bytes32"},{"indexed":false,"name":"address0","type":"address"},{"indexed":false,"name":"address1","type":"address"},{"indexed":false,"name":"phase","type":"uint8"},{"indexed":false,"name":"challengePeriod","type":"uint256"},{"indexed":false,"name":"closingBlock","type":"uint256"},{"indexed":false,"name":"state","type":"bytes"},{"indexed":false,"name":"sequenceNumber","type":"uint256"}],"name":"LogClosedChannel","type":"event"}]
const bytecode = '6060604052341561000c57fe5b5b6119fe8061001c6000396000f300606060405236156100675763ffffffff60e060020a6000350416632af3b7f8811461006957806339cdde321461013f5780636d46398b146101b557806377d32e94146102a057806380ef353d14610313578063831c2b82146103285780639013d1ed14610423575bfe5b341561007157fe5b604080516020600460443581810135601f810184900484028501840190955284845261013d94823594602480359560649492939190920191819084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375094965061048795505050505050565b005b341561014757fe5b60408051602060046024803582810135601f81018590048502860185019096528585526101a1958335959394604494939290920191819084018382808284375094965050509235600160a060020a031692506109b7915050565b604080519115158252519081900360200190f35b34156101bd57fe5b604080516020601f60643560048181013592830184900484028501840190955281845261013d94803594600160a060020a0360248035821696604435909216959394608494910191819084018382808284375050604080516020601f818a01358b0180359182018390048302840183018552818452989a8a359a90999401975091955091820193509150819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979998810197919650918201945092508291508401838280828437509496506109e195505050505050565b005b34156102a857fe5b60408051602060046024803582810135601f81018590048502860185019096528585526102f79583359593946044949392909201918190840183828082843750949650610e8495505050505050565b60408051600160a060020a039092168252519081900360200190f35b341561031b57fe5b61013d600435610f4f565b005b341561033057fe5b61033b600435611260565b60405180896000191660001916815260200188600160a060020a0316600160a060020a0316815260200187600160a060020a0316600160a060020a031681526020018660ff1660ff168152602001858152602001848152602001806020018381526020018281038252848181518152602001915080519060200190808383600083146103e2575b8051825260208311156103e257601f1990920191602091820191016103c2565b505050905090810190601f16801561040e5780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390f35b341561042b57fe5b60408051602060046024803582810135601f810185900485028601850190965285855261013d958335959394604494939290920191819084018382808284375094965050509235600160a060020a031692506113a5915050565b005b61048f6118a2565b600061049a87610f4f565b600087815260208181526040918290208251610100808201855282548252600180840154600160a060020a03908116848701526002808601549182168589015260a060020a90910460ff16606085015260038501546080850152600485015460a08501526005850180548851600019948216159095029390930190921604601f81018690048602830186019096528582529194929360c0860193919291908301828280156105895780601f1061055e57610100808354040283529160200191610589565b820191906000526020600020905b81548152906001019060200180831161056c57829003601f168201915b505050505081526020016006820154815250509150600260ff16826060015160ff16141561060457604080516020808252600e908201527f6368616e6e656c20636c6f7365640000000000000000000000000000000000008183015290516000805160206119b38339815191529181900360600190a16109ae565b6040517f75706461746553746174650000000000000000000000000000000000000000008152600b8101889052602b8101879052855188918891889190604b82019060208401908083835b6020831061066e5780518252601f19909201916020918201910161064f565b6001836020036101000a0380198251168184511680821785525050505050509050019350505050604051809103902090506106ae818584602001516109b7565b1515610707576040805160208082526012908201527f7369676e61747572653020696e76616c696400000000000000000000000000008183015290516000805160206119b38339815191529181900360600190a16109ae565b610716818484604001516109b7565b151561076f576040805160208082526012908201527f7369676e61747572653120696e76616c696400000000000000000000000000008183015290516000805160206119b38339815191529181900360600190a16109ae565b60e082015186116107cd576040805160208082526017908201527f73657175656e6365206e756d62657220746f6f206c6f770000000000000000008183015290516000805160206119b38339815191529181900360600190a16109ae565b60c0820185815260e08301879052600088815260208181526040918290208551815581860151600182018054600160a060020a03928316600160a060020a0319918216179091559387015160028301805460608a015160ff1660a060020a0260a060020a60ff02199390941696169590951716179092556080850151600383015560a0850151600483015591518051859361086f9260058501929101906118ee565b5060e082015181600601559050507f4a92468ea514ef44918d339838efaa4bc2d76ddc9bc05f5e0e2b7788599476f7826000015183602001518460400151856060015186608001518760a001518860c001518960e0015160405180896000191660001916815260200188600160a060020a0316600160a060020a0316815260200187600160a060020a0316600160a060020a031681526020018660ff1660ff1681526020018581526020018481526020018060200183815260200182810382528481815181526020019150805190602001908083836000831461096d575b80518252602083111561096d57601f19909201916020918201910161094d565b505050905090810190601f1680156109995780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390a15b50505050505050565b600081600160a060020a03166109cd8585610e84565b600160a060020a03161490505b9392505050565b60006109eb6118a2565b600089815260208190526040902054891415610a7a57604080516020808252602a908201527f6368616e6e656c20776974682074686174206368616e6e656c496420616c7265818301527f6164792065786973747300000000000000000000000000000000000000000000606082015290516000805160206119b38339815191529181900360800190a1610e79565b6040517f6e65774368616e6e656c000000000000000000000000000000000000000000008152600a81018a90526c01000000000000000000000000600160a060020a03808b168202602a840152891602603e82015286518a918a918a918a918a9190605282019060208501908083835b60208310610b095780518252601f199092019160209182019101610aea565b6001836020036101000a0380198251168184511680821785525050505050509050018281526020019550505050505060405180910390209150610b4d82858a6109b7565b1515610ba6576040805160208082526012908201527f7369676e61747572653020696e76616c696400000000000000000000000000008183015290516000805160206119b38339815191529181900360600190a1610e79565b610bb18284896109b7565b1515610c0a576040805160208082526012908201527f7369676e61747572653120696e76616c696400000000000000000000000000008183015290516000805160206119b38339815191529181900360600190a1610e79565b610100604051908101604052808a60001916815260200189600160a060020a0316815260200188600160a060020a03168152602001600060ff168152602001868152602001600081526020018781526020016000815250905080600060008b600019166000191681526020019081526020016000206000820151816000019060001916905560208201518160010160006101000a815481600160a060020a030219169083600160a060020a0316021790555060408201518160020160006101000a815481600160a060020a030219169083600160a060020a0316021790555060608201518160020160146101000a81548160ff021916908360ff1602179055506080820151816003015560a0820151816004015560c0820151816005019080519060200190610d3a9291906118ee565b5060e082015181600601559050507fcfe845afd92a26dd57b921f58e710b416422395afcb2463b6af75f8e3f4bb9f5816000015182602001518360400151846060015185608001518660a001518760c001518860e0015160405180896000191660001916815260200188600160a060020a0316600160a060020a0316815260200187600160a060020a0316600160a060020a031681526020018660ff1660ff16815260200185815260200184815260200180602001838152602001828103825284818151815260200191508051906020019080838360008314610e38575b805182526020831115610e3857601f199092019160209182019101610e18565b505050905090810190601f168015610e645780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390a15b505050505050505050565b60006000600060006000600060006001925087516041141515610ea657610000565b6020880151604089015160418a015191975095509350839250601b60ff84161015610ed65782601b019150610eda565b8291505b6040805160008181526020808301845291830181905282518c815260ff8616818401528084018a905260608101899052925160019360808082019493601f19840193928390039091019190866161da5a03f11515610f3457fe5b50506020604051035190508096505b50505050505092915050565b610f576118a2565b600082815260208181526040918290208251610100808201855282548252600180840154600160a060020a03908116848701526002808601549182168589015260a060020a90910460ff16606085015260038501546080850152600485015460a08501526005850180548851600019948216159095029390930190921604601f81018690048602830186019096528582529194929360c0860193919291908301828280156110465780601f1061101b57610100808354040283529160200191611046565b820191906000526020600020905b81548152906001019060200180831161102957829003601f168201915b505050505081526020016006820154815250509050600160ff16816060015160ff1614801561107857508060a0015143115b1561108557600260608201525b600082815260208181526040918290208351815581840151600182018054600160a060020a03928316600160a060020a03199182161790915593850151600283018054606088015160ff1660a060020a0260a060020a60ff02199390941696169590951716179092556080830151600383015560a0830151600483015560c0830151805184939261111d9260058501929101906118ee565b5060e082015181600601559050507f1f39b70277b767e84f67b6f8549d0f47206341cc194406bda5b088cae648c756816000015182602001518360400151846060015185608001518660a001518760c001518860e0015160405180896000191660001916815260200188600160a060020a0316600160a060020a0316815260200187600160a060020a0316600160a060020a031681526020018660ff1660ff1681526020018581526020018481526020018060200183815260200182810382528481815181526020019150805190602001908083836000831461121b575b80518252602083111561121b57601f1990920191602091820191016111fb565b505050905090810190601f1680156112475780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390a15b5050565b60006000600060006000600061127461196d565b60006000600060008b600019166000191681526020019081526020016000209050806000015498508060010160009054906101000a9004600160a060020a031697508060020160009054906101000a9004600160a060020a031696508060020160149054906101000a900460ff1695508060030154945080600401549350806005018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561138a5780601f1061135f5761010080835404028352916020019161138a565b820191906000526020600020905b81548152906001019060200180831161136d57829003601f168201915b50505050509250806006015491505b50919395975091939597565b6113ad6118a2565b6000848152602081815260408083208151610100808201845282548252600180840154600160a060020a03908116848801526002808601549182168588015260a060020a90910460ff16606085015260038501546080850152600485015460a08501526005850180548751600019948216159095029390930190921604601f81018790048702830187019095528482529194929360c086019391929183018282801561149a5780601f1061146f5761010080835404028352916020019161149a565b820191906000526020600020905b81548152906001019060200180831161147d57829003601f168201915b505050918352505060069190910154602090910152606081015190925060ff1615611512576040805160208082526010908201527f6368616e6e656c206e6f74206f70656e000000000000000000000000000000008183015290516000805160206119b38339815191529181900360600190a161189b565b50604080517f73746172744368616c6c656e6765506572696f6400000000000000000000000081526014810186905290519081900360340190206020820151600160a060020a03848116911614156115d157611573818584602001516109b7565b15156115cc576040805160208082526011908201527f7369676e617475726520696e76616c69640000000000000000000000000000008183015290516000805160206119b38339815191529181900360600190a161189b565b6116af565b8160400151600160a060020a031683600160a060020a0316141561165c57611573818584604001516109b7565b15156115cc576040805160208082526011908201527f7369676e617475726520696e76616c69640000000000000000000000000000008183015290516000805160206119b38339815191529181900360600190a161189b565b6116af565b604080516020808252600e908201527f7369676e657220696e76616c69640000000000000000000000000000000000008183015290516000805160206119b38339815191529181900360600190a161189b565b5b608082018051430160a084019081526001606085018181526000898152602081815260409182902088518155818901519481018054600160a060020a0319908116600160a060020a03978816179091559289015160028201805495519590941695169490941760a060020a60ff02191660a060020a60ff90941693909302929092179055925160038201559051600482015560c08401518051859361175c9260058501929101906118ee565b5060e082015181600601559050507f9b07fa864d7898dc3b94402e7448da18910f9f428a37b4206d979a8e7013adc2826000015183602001518460400151856060015186608001518760a001518860c001518960e0015160405180896000191660001916815260200188600160a060020a0316600160a060020a0316815260200187600160a060020a0316600160a060020a031681526020018660ff1660ff1681526020018581526020018481526020018060200183815260200182810382528481815181526020019150805190602001908083836000831461185a575b80518252602083111561185a57601f19909201916020918201910161183a565b505050905090810190601f1680156118865780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390a15b5050505050565b6040805161010081018252600080825260208201819052918101829052606081018290526080810182905260a081019190915260c081016118e161196d565b8152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061192f57805160ff191683800117855561195c565b8280016001018555821561195c579182015b8281111561195c578251825591602001919060010190611941565b5b50611969929150611991565b5090565b60408051602081019091526000815290565b60408051602081019091526000815290565b6119af91905b808211156119695760008155600101611997565b5090565b90560008c379a0afcc32b1a39302f7cb8073359698411ab5fd6e3edb2c02c0b5fba8aaa165627a7a7230582040c8585c1cdd60d2cfb242f33a65268ff21a7533dfcabeab9fb64e663adae3f10029'

const storageLocationNodeA = argv.sa || path.join(__dirname, '../data/storage/nodeA')
const storageLocationNodeB = argv.sb || path.join(__dirname, '../data/storage/nodeB')

const portNodeA = argv.na || 4021
const portNodeB = argv.nb || 4022

const addressNodeA = argv.aa || '0x0077cdf65cAD0b5ca9C2af69CD6743f396f616F0' // ALICE
const addressNodeB = argv.ab || '0x00798eaa5c12FD38ff58aD51c985D805C02eB429' // BOB

;(async () => {
  
  // MAKE WEB3
  const providerNodeA = new Web3.providers.HttpProvider(web3Provider)
  const providerNodeB = new Web3.providers.HttpProvider(web3Provider)
  
  const web3NodeA = new Web3()
  web3NodeA.setProvider(providerNodeA)
  web3NodeA.eth.defaultAccount = addressNodeA

  var StateChannelsNodeA = Contract({
    abi: abi,
    address: contractAddress,
    network_id: 3,
    networks: [3],
    binary: bytecode
  })
  StateChannelsNodeA.setProvider(providerNodeB)
  StateChannelsNodeA.setDefaultAccount(addressNodeA)
  var contractNodeA = await StateChannelsNodeA.deployed()

  const web3NodeB = new Web3()
  web3NodeB.setProvider(providerNodeB)
  web3NodeB.eth.defaultAccount = addressNodeB

  var StateChannelsNodeB = Contract({
    abi: abi,
    address: contractAddress,
    network_id: 3,
    networks: [3],
    binary: bytecode
  })
  StateChannelsNodeB.setProvider(providerNodeA)
  StateChannelsNodeB.setDefaultAccount(addressNodeB)
  var contractNodeB = await StateChannelsNodeB.deployed()

  console.log(StateChannelsNodeA === StateChannelsNodeB)

  var JSONStorage = require('node-localstorage').JSONStorage
  var storageNodeA = new JSONStorage(storageLocationNodeA)
  var storageNodeB = new JSONStorage(storageLocationNodeB)

  const post = p(function (url, body, callback) {
    request.post({
      url,
      body,
      json: true,
    }, callback)
  })

  var globalsNodeA = {
    name: 'Node A',
    storage: storageNodeA,
    address: addressNodeA,
    url: 'http://localhost:' + portNodeA,
    contract: contractNodeA,
    web3: web3NodeA,
    post
  }

  var globalsNodeB = {
    name: 'Node B',
    storage: storageNodeB,
    address: addressNodeB,
    url: 'http://localhost:' + portNodeB,
    contract: contractNodeB,
    web3: web3NodeB,
    post
  }

  var node = require('./servers/node.js')
  var nodeA = node.default(globalsNodeA)
  var nodeB = node.default(globalsNodeB)

  nodeA.listen(portNodeA, () => console.log('nodeA listening on ' + portNodeA))
  nodeB.listen(portNodeB, () => console.log('nodeB listening on ' + portNodeB))

})().catch(err => console.error(err))

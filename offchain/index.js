// cli options
// -na caller port
// -nb peer port
// -sa storage location nodeA
// -sb storage location nodeB
// -w web3 provider
// -aa nodeA ETH account address
// -ab nodeB ETH account address

import minimist from 'minimist'
import path from 'path'
import request from 'request'
import p from 'es6-promisify'
import Web3 from 'web3'
import Contract from 'truffle-contract'
import fs from 'fs'
import solc from 'solc'

const argv = minimist(process.argv.slice(2))

const web3Provider = argv.w || 'http://localhost:8545'
const contractAddress = '0xfbe6bab122e739352ad0ff07a0a4496fb2feb1b3'
const abi = [{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"},{"name":"sequenceNumber","type":"uint256"},{"name":"state","type":"bytes"},{"name":"signature0","type":"bytes"},{"name":"signature1","type":"bytes"}],"name":"updateState","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"hash","type":"bytes32"},{"name":"sig","type":"bytes"},{"name":"signer","type":"address"}],"name":"ecverify","outputs":[{"name":"b","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"}],"name":"deleteChannel","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"},{"name":"address0","type":"address"},{"name":"address1","type":"address"},{"name":"state","type":"bytes"},{"name":"challengePeriod","type":"uint256"},{"name":"signature0","type":"bytes"},{"name":"signature1","type":"bytes"}],"name":"newChannel","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"hash","type":"bytes32"},{"name":"sig","type":"bytes"}],"name":"ecrecovery","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"}],"name":"tryClose","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"inputChannelId","type":"bytes32"}],"name":"getChannel","outputs":[{"name":"channelId","type":"bytes32"},{"name":"address0","type":"address"},{"name":"address1","type":"address"},{"name":"phase","type":"uint8"},{"name":"challengePeriod","type":"uint256"},{"name":"closingBlock","type":"uint256"},{"name":"state","type":"bytes"},{"name":"sequenceNumber","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"},{"name":"signature","type":"bytes"},{"name":"signer","type":"address"}],"name":"startChallengePeriod","outputs":[],"payable":false,"type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"message","type":"string"}],"name":"Error","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"channelId","type":"bytes32"},{"indexed":false,"name":"address0","type":"address"},{"indexed":false,"name":"address1","type":"address"},{"indexed":false,"name":"phase","type":"uint8"},{"indexed":false,"name":"challengePeriod","type":"uint256"},{"indexed":false,"name":"closingBlock","type":"uint256"},{"indexed":false,"name":"state","type":"bytes"},{"indexed":false,"name":"sequenceNumber","type":"uint256"}],"name":"LogAcceptedChannel","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"channelId","type":"bytes32"},{"indexed":false,"name":"address0","type":"address"},{"indexed":false,"name":"address1","type":"address"},{"indexed":false,"name":"phase","type":"uint8"},{"indexed":false,"name":"challengePeriod","type":"uint256"},{"indexed":false,"name":"closingBlock","type":"uint256"},{"indexed":false,"name":"state","type":"bytes"},{"indexed":false,"name":"sequenceNumber","type":"uint256"}],"name":"LogAcceptedUpdate","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"channelId","type":"bytes32"},{"indexed":false,"name":"address0","type":"address"},{"indexed":false,"name":"address1","type":"address"},{"indexed":false,"name":"phase","type":"uint8"},{"indexed":false,"name":"challengePeriod","type":"uint256"},{"indexed":false,"name":"closingBlock","type":"uint256"},{"indexed":false,"name":"state","type":"bytes"},{"indexed":false,"name":"sequenceNumber","type":"uint256"}],"name":"LogDeletedChannel","type":"event"}]
const bytecode = '6060604052341561000c57fe5b5b6118d18061001c6000396000f300606060405236156100725763ffffffff60e060020a6000350416632af3b7f8811461007457806339cdde321461014a57806360cb5fac146101c05780636d46398b146101d557806377d32e94146102c057806380ef353d14610333578063831c2b82146103485780639013d1ed14610443575bfe5b341561007c57fe5b604080516020600460443581810135601f810184900484028501840190955284845261014894823594602480359560649492939190920191819084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979998810197919650918201945092508291508401838280828437509496506104a795505050505050565b005b341561015257fe5b60408051602060046024803582810135601f81018590048502860185019096528585526101ac958335959394604494939290920191819084018382808284375094965050509235600160a060020a0316925061093a915050565b604080519115158252519081900360200190f35b34156101c857fe5b610148600435610964565b005b34156101dd57fe5b604080516020601f60643560048181013592830184900484028501840190955281845261014894803594600160a060020a0360248035821696604435909216959394608494910191819084018382808284375050604080516020601f818a01358b0180359182018390048302840183018552818452989a8a359a90999401975091955091820193509150819084018382808284375050604080516020601f89358b01803591820183900483028401830190945280835297999881019791965091820194509250829150840183828082843750949650610bf195505050505050565b005b34156102c857fe5b60408051602060046024803582810135601f8101859004850286018501909652858552610317958335959394604494939290920191819084018382808284375094965061109495505050505050565b60408051600160a060020a039092168252519081900360200190f35b341561033b57fe5b610148600435611149565b005b341561035057fe5b61035b600435611284565b60405180896000191660001916815260200188600160a060020a0316600160a060020a0316815260200187600160a060020a0316600160a060020a031681526020018660ff1660ff16815260200185815260200184815260200180602001838152602001828103825284818151815260200191508051906020019080838360008314610402575b80518252602083111561040257601f1990920191602091820191016103e2565b505050905090810190601f16801561042e5780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390f35b341561044b57fe5b60408051602060046024803582810135601f8101859004850286018501909652858552610148958335959394604494939290920191819084018382808284375094965050509235600160a060020a031692506113c9915050565b005b6104af6116ef565b60006104ba87611149565b600087815260208181526040918290208251610100808201855282548252600180840154600160a060020a03908116848701526002808601549182168589015260a060020a90910460ff16606085015260038501546080850152600485015460a08501526005850180548851600019948216159095029390930190921604601f81018690048602830186019096528582529194929360c0860193919291908301828280156105a95780601f1061057e576101008083540402835291602001916105a9565b820191906000526020600020905b81548152906001019060200180831161058c57829003601f168201915b505050505081526020016006820154815250509150600260ff16826060015160ff16141561062457604080516020808252600e908201527f6368616e6e656c20636c6f7365640000000000000000000000000000000000008183015290516000805160206118868339815191529181900360600190a1610931565b6040517f75706461746553746174650000000000000000000000000000000000000000008152600b8101889052602b8101879052855188918891889190604b82019060208401908083835b6020831061068e5780518252601f19909201916020918201910161066f565b6001836020036101000a0380198251168184511680821785525050505050509050019350505050604051809103902090506106ce8185846020015161093a565b1515610727576040805160208082526012908201527f7369676e61747572653020696e76616c696400000000000000000000000000008183015290516000805160206118868339815191529181900360600190a1610931565b6107368184846040015161093a565b151561078f576040805160208082526012908201527f7369676e61747572653120696e76616c696400000000000000000000000000008183015290516000805160206118868339815191529181900360600190a1610931565b60e082015186116107ed576040805160208082526017908201527f73657175656e6365206e756d62657220746f6f206c6f770000000000000000008183015290516000805160206118868339815191529181900360600190a1610931565b848260c00181905250858260e00181815250507fcfe845afd92a26dd57b921f58e710b416422395afcb2463b6af75f8e3f4bb9f5826000015183602001518460400151856060015186608001518760a001518860c001518960e0015160405180896000191660001916815260200188600160a060020a0316600160a060020a0316815260200187600160a060020a0316600160a060020a031681526020018660ff1660ff168152602001858152602001848152602001806020018381526020018281038252848181518152602001915080519060200190808383600083146108f0575b8051825260208311156108f057601f1990920191602091820191016108d0565b505050905090810190601f16801561091c5780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390a15b50505050505050565b600081600160a060020a03166109508585611094565b600160a060020a03161490505b9392505050565b6000818152602081905260409020805482146109f357604080516020808252602a908201527f6368616e6e656c20776974682074686174206368616e6e656c496420646f6573818301527f206e6f7420657869737400000000000000000000000000000000000000000000606082015290516000805160206118868339815191529181900360800190a1610bed565b805460018083015460028085015460038601546004870154600688015460408051898152600160a060020a039788166020820181905297861691810182905260ff60a060020a90960495909516606086018190526080860185905260a0860184905260e0860183905261010060c0870181815260058d0180549b8c1615830260001901909b16989098049087018190527fa4fc3a6fe4b3ec7ba49670990463c0f8df3f35e42902ca824723de4273a12f759a9992979196929392919061012083019085908015610b045780601f10610ad957610100808354040283529160200191610b04565b820191906000526020600020905b815481529060010190602001808311610ae757829003601f168201915b5050995050505050505050505060405180910390a16000808255828152602081905260408120908155600182810154828201805473ffffffffffffffffffffffffffffffffffffffff19908116600160a060020a0393841617909155600280860180548287018054909416941693909317808355925460ff60a060020a91829004160274ff000000000000000000000000000000000000000019909316929092179055600380850154908401556004808501549084015560058085018054869594610be294938601939082161561010002600019019091160461173b565b506006918201549101555b5050565b6000610bfb6116ef565b600089815260208190526040902054891415610c8a57604080516020808252602a908201527f6368616e6e656c20776974682074686174206368616e6e656c496420616c7265818301527f6164792065786973747300000000000000000000000000000000000000000000606082015290516000805160206118868339815191529181900360800190a1611089565b6040517f6e65774368616e6e656c000000000000000000000000000000000000000000008152600a81018a90526c01000000000000000000000000600160a060020a03808b168202602a840152891602603e82015286518a918a918a918a918a9190605282019060208501908083835b60208310610d195780518252601f199092019160209182019101610cfa565b6001836020036101000a0380198251168184511680821785525050505050509050018281526020019550505050505060405180910390209150610d5d82858a61093a565b1515610db6576040805160208082526012908201527f7369676e61747572653020696e76616c696400000000000000000000000000008183015290516000805160206118868339815191529181900360600190a1611089565b610dc182848961093a565b1515610e1a576040805160208082526012908201527f7369676e61747572653120696e76616c696400000000000000000000000000008183015290516000805160206118868339815191529181900360600190a1611089565b610100604051908101604052808a60001916815260200189600160a060020a0316815260200188600160a060020a03168152602001600060ff168152602001868152602001600081526020018781526020016000815250905080600060008b600019166000191681526020019081526020016000206000820151816000019060001916905560208201518160010160006101000a815481600160a060020a030219169083600160a060020a0316021790555060408201518160020160006101000a815481600160a060020a030219169083600160a060020a0316021790555060608201518160020160146101000a81548160ff021916908360ff1602179055506080820151816003015560a0820151816004015560c0820151816005019080519060200190610f4a9291906117c1565b5060e082015181600601559050507fcfe845afd92a26dd57b921f58e710b416422395afcb2463b6af75f8e3f4bb9f5816000015182602001518360400151846060015185608001518660a001518760c001518860e0015160405180896000191660001916815260200188600160a060020a0316600160a060020a0316815260200187600160a060020a0316600160a060020a031681526020018660ff1660ff16815260200185815260200184815260200180602001838152602001828103825284818151815260200191508051906020019080838360008314611048575b80518252602083111561104857601f199092019160209182019101611028565b505050905090810190601f1680156110745780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390a15b505050505050505050565b60006000600060006000855160411415156110ae57610000565b602086015193506040860151925060418601519150601b8260ff1610156110d657601b820191505b6040805160008181526020808301845291830181905282518a815260ff86168184015280840188905260608101879052925160019360808082019493601f19840193928390039091019190866161da5a03f1151561113057fe5b50506020604051035190508094505b5050505092915050565b6111516116ef565b600082815260208181526040918290208251610100808201855282548252600180840154600160a060020a03908116848701526002808601549182168589015260a060020a90910460ff16606085015260038501546080850152600485015460a08501526005850180548851600019948216159095029390930190921604601f81018690048602830186019096528582529194929360c0860193919291908301828280156112405780601f1061121557610100808354040283529160200191611240565b820191906000526020600020905b81548152906001019060200180831161122357829003601f168201915b505050505081526020016006820154815250509050600160ff16816060015160ff1614801561127257508060a0015143115b15610bed57600260608201525b5b5050565b600060006000600060006000611298611840565b60006000600060008b600019166000191681526020019081526020016000209050806000015498508060010160009054906101000a9004600160a060020a031697508060020160009054906101000a9004600160a060020a031696508060020160149054906101000a900460ff1695508060030154945080600401549350806005018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156113ae5780601f10611383576101008083540402835291602001916113ae565b820191906000526020600020905b81548152906001019060200180831161139157829003601f168201915b50505050509250806006015491505b50919395975091939597565b6113d16116ef565b6000848152602081815260408083208151610100808201845282548252600180840154600160a060020a03908116848801526002808601549182168588015260a060020a90910460ff16606085015260038501546080850152600485015460a08501526005850180548751600019948216159095029390930190921604601f81018790048702830187019095528482529194929360c08601939192918301828280156114be5780601f10611493576101008083540402835291602001916114be565b820191906000526020600020905b8154815290600101906020018083116114a157829003601f168201915b505050918352505060069190910154602090910152606081015190925060ff1615611536576040805160208082526010908201527f6368616e6e656c206e6f74206f70656e000000000000000000000000000000008183015290516000805160206118868339815191529181900360600190a16116e8565b50604080517f73746172744368616c6c656e6765506572696f6400000000000000000000000081526014810186905290519081900360340190206020820151600160a060020a03848116911614156115f5576115978185846020015161093a565b15156115f0576040805160208082526011908201527f7369676e617475726520696e76616c69640000000000000000000000000000008183015290516000805160206118868339815191529181900360600190a16116e8565b6116d3565b8160400151600160a060020a031683600160a060020a03161415611680576115978185846040015161093a565b15156115f0576040805160208082526011908201527f7369676e617475726520696e76616c69640000000000000000000000000000008183015290516000805160206118868339815191529181900360600190a16116e8565b6116d3565b604080516020808252600e908201527f7369676e657220696e76616c69640000000000000000000000000000000000008183015290516000805160206118868339815191529181900360600190a16116e8565b5b6080820151430160a0830152600160608301525b5050505050565b6040805161010081018252600080825260208201819052918101829052606081018290526080810182905260a081019190915260c0810161172e611840565b8152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061177457805485556117b0565b828001600101855582156117b057600052602060002091601f016020900482015b828111156117b0578254825591600101919060010190611795565b5b506117bd929150611864565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061180257805160ff19168380011785556117b0565b828001600101855582156117b0579182015b828111156117b0578251825591602001919060010190611814565b5b506117bd929150611864565b5090565b60408051602081019091526000815290565b60408051602081019091526000815290565b61188291905b808211156117bd576000815560010161186a565b5090565b90560008c379a0afcc32b1a39302f7cb8073359698411ab5fd6e3edb2c02c0b5fba8aaa165627a7a7230582050dc6fa901d34c028994fd6e86fd1b6c7406b7f0aec271e7e3f1d059dbea45270029'

const storageLocationNodeA = argv.sa || path.join(__dirname, '../data/storage/nodeA')
const storageLocationNodeB = argv.sb || path.join(__dirname, '../data/storage/nodeB')

const portNodeA = argv.na || 4021
const portNodeB = argv.nb || 4022

const addressNodeA = argv.aa || '0x0077cdf65cAD0b5ca9C2af69CD6743f396f616F0' // ALICE
const addressNodeB = argv.ab || '0x00798eaa5c12FD38ff58aD51c985D805C02eB429' // BOB

;(async () => {
  // MAKE WEB3
  const web3 = new Web3()
  const provider = new Web3.providers.HttpProvider(web3Provider)
  web3.setProvider(provider)
  const accounts = await p(web3.eth.getAccounts)()
  web3.eth.defaultAccount = accounts[0]

  var StateChannels = Contract({
    abi: abi,
    address: contractAddress,
    network_id: 3,
    networks: [3],
    binary: bytecode
  })
  StateChannels.setProvider(provider)
  StateChannels.setDefaultAccount(accounts[0]) // TODO DOVREBBE ESSERE L'ACCOUNT definito nel nodo
  var contract = await StateChannels.deployed()
  // console.log(`contract address: ${contract.address}, network: ${StateChannels.hasNetwork(3)}`)

  var JSONStorage = require('node-localstorage').JSONStorage
  var storageNodeA = new JSONStorage(storageLocationNodeA)
  var storageNodeB = new JSONStorage(storageLocationNodeB)

  const post = p(function (url, body, callback) {
    request.post({
      url,
      body,
      json: true,
    }, callback)
  })

  var globalsNodeA = {
    name: 'Node A',
    storage: storageNodeA,
    address: addressNodeA,
    url: 'http://localhost/' + portNodeA,
    contract,
    web3,
    post
  }

  var globalsNodeB = {
    name: 'Node B',
    storage: storageNodeB,
    address: addressNodeB,
    url: 'http://localhost/' + portNodeB,
    contract,
    web3,
    post
  }

  var node = require('./servers/node.js')
  var nodeA = node.default(globalsNodeA)
  var nodeB = node.default(globalsNodeB)

  nodeA.listen(portNodeA, () => console.log('nodeA listening on ' + portNodeA))
  nodeB.listen(portNodeB, () => console.log('nodeB listening on ' + portNodeB))

})().catch(err => console.error(err))

// cli options
// -c caller port
// -p peer port
// -s contract address
// -f storage location
// -w web3 provider

import minimist from 'minimist'
import path from 'path'
import request from 'request'
import p from 'es6-promisify'
import Web3 from 'web3'
import Contract from 'truffle-contract'
import fs from 'fs'
import solc from 'solc'

const PUDDING_PATH = path.resolve(__dirname + '/../pudding/')

const argv = minimist(process.argv.slice(2))
const peerPort = argv.c || 4020
const callerPort = argv.p || 3020
const contractAddress = argv.s || '0xd3bd9b5a203b74350f52f71bd17181d94d6eb2c2' // '0x5d078d6d4407d927169719706e644a064e67362f'
const abi = [{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"},{"name":"sequenceNumber","type":"uint256"},{"name":"state","type":"bytes"},{"name":"signature0","type":"bytes"},{"name":"signature1","type":"bytes"}],"name":"updateState","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"hash","type":"bytes32"},{"name":"sig","type":"bytes"},{"name":"signer","type":"address"}],"name":"ecverify","outputs":[{"name":"b","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"}],"name":"deleteChannel","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"},{"name":"address0","type":"address"},{"name":"address1","type":"address"},{"name":"state","type":"bytes"},{"name":"challengePeriod","type":"uint256"},{"name":"signature0","type":"bytes"},{"name":"signature1","type":"bytes"}],"name":"newChannel","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"hash","type":"bytes32"},{"name":"sig","type":"bytes"}],"name":"ecrecovery","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"}],"name":"tryClose","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"}],"name":"getChannel","outputs":[{"name":"address0","type":"address"},{"name":"address1","type":"address"},{"name":"phase","type":"uint8"},{"name":"challengePeriod","type":"uint256"},{"name":"closingBlock","type":"uint256"},{"name":"state","type":"bytes"},{"name":"sequenceNumber","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"channelId","type":"bytes32"},{"name":"signature","type":"bytes"},{"name":"signer","type":"address"}],"name":"startChallengePeriod","outputs":[],"payable":false,"type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"message","type":"string"}],"name":"Error","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"channelId","type":"bytes32"},{"indexed":false,"name":"address0","type":"address"},{"indexed":false,"name":"address1","type":"address"},{"indexed":false,"name":"phase","type":"uint8"},{"indexed":false,"name":"challengePeriod","type":"uint256"},{"indexed":false,"name":"closingBlock","type":"uint256"},{"indexed":false,"name":"state","type":"bytes"},{"indexed":false,"name":"sequenceNumber","type":"uint256"}],"name":"LogAcceptedChannel","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"channelId","type":"bytes32"},{"indexed":false,"name":"address0","type":"address"},{"indexed":false,"name":"address1","type":"address"},{"indexed":false,"name":"phase","type":"uint8"},{"indexed":false,"name":"challengePeriod","type":"uint256"},{"indexed":false,"name":"closingBlock","type":"uint256"},{"indexed":false,"name":"state","type":"bytes"},{"indexed":false,"name":"sequenceNumber","type":"uint256"}],"name":"LogAcceptedUpdate","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"channelId","type":"bytes32"},{"indexed":false,"name":"address0","type":"address"},{"indexed":false,"name":"address1","type":"address"},{"indexed":false,"name":"phase","type":"uint8"},{"indexed":false,"name":"challengePeriod","type":"uint256"},{"indexed":false,"name":"closingBlock","type":"uint256"},{"indexed":false,"name":"state","type":"bytes"},{"indexed":false,"name":"sequenceNumber","type":"uint256"}],"name":"LogDeletedChannel","type":"event"}]
const bytecode = '6060604052341561000c57fe5b5b61189b8061001c6000396000f300606060405236156100725763ffffffff60e060020a6000350416632af3b7f8811461007457806339cdde321461014a57806360cb5fac146101c05780636d46398b146101d557806377d32e94146102c057806380ef353d14610333578063831c2b82146103485780639013d1ed14610434575bfe5b341561007c57fe5b604080516020600460443581810135601f810184900484028501840190955284845261014894823594602480359560649492939190920191819084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375094965061049895505050505050565b005b341561015257fe5b60408051602060046024803582810135601f81018590048502860185019096528585526101ac958335959394604494939290920191819084018382808284375094965050509235600160a060020a0316925061092b915050565b604080519115158252519081900360200190f35b34156101c857fe5b610148600435610955565b005b34156101dd57fe5b604080516020601f60643560048181013592830184900484028501840190955281845261014894803594600160a060020a0360248035821696604435909216959394608494910191819084018382808284375050604080516020601f818a01358b0180359182018390048302840183018552818452989a8a359a90999401975091955091820193509150819084018382808284375050604080516020601f89358b01803591820183900483028401830190945280835297999881019791965091820194509250829150840183828082843750949650610be295505050505050565b005b34156102c857fe5b60408051602060046024803582810135601f8101859004850286018501909652858552610317958335959394604494939290920191819084018382808284375094965061108595505050505050565b60408051600160a060020a039092168252519081900360200190f35b341561033b57fe5b610148600435611150565b005b341561035057fe5b61035b60043561128b565b6040518088600160a060020a0316600160a060020a0316815260200187600160a060020a0316600160a060020a031681526020018660ff1660ff168152602001858152602001848152602001806020018381526020018281038252848181518152602001915080519060200190808383600083146103f4575b8051825260208311156103f457601f1990920191602091820191016103d4565b505050905090810190601f1680156104205780820380516001836020036101000a031916815260200191505b509850505050505050505060405180910390f35b341561043c57fe5b60408051602060046024803582810135601f8101859004850286018501909652858552610148958335959394604494939290920191819084018382808284375094965050509235600160a060020a03169250611393915050565b005b6104a06116b9565b60006104ab87611150565b600087815260208181526040918290208251610100808201855282548252600180840154600160a060020a03908116848701526002808601549182168589015260a060020a90910460ff16606085015260038501546080850152600485015460a08501526005850180548851600019948216159095029390930190921604601f81018690048602830186019096528582529194929360c08601939192919083018282801561059a5780601f1061056f5761010080835404028352916020019161059a565b820191906000526020600020905b81548152906001019060200180831161057d57829003601f168201915b505050505081526020016006820154815250509150600260ff16826060015160ff16141561061557604080516020808252600e908201527f6368616e6e656c20636c6f7365640000000000000000000000000000000000008183015290516000805160206118508339815191529181900360600190a1610922565b6040517f75706461746553746174650000000000000000000000000000000000000000008152600b8101889052602b8101879052855188918891889190604b82019060208401908083835b6020831061067f5780518252601f199092019160209182019101610660565b6001836020036101000a0380198251168184511680821785525050505050509050019350505050604051809103902090506106bf8185846020015161092b565b1515610718576040805160208082526012908201527f7369676e61747572653020696e76616c696400000000000000000000000000008183015290516000805160206118508339815191529181900360600190a1610922565b6107278184846040015161092b565b1515610780576040805160208082526012908201527f7369676e61747572653120696e76616c696400000000000000000000000000008183015290516000805160206118508339815191529181900360600190a1610922565b60e082015186116107de576040805160208082526017908201527f73657175656e6365206e756d62657220746f6f206c6f770000000000000000008183015290516000805160206118508339815191529181900360600190a1610922565b848260c00181905250858260e00181815250507fcfe845afd92a26dd57b921f58e710b416422395afcb2463b6af75f8e3f4bb9f5826000015183602001518460400151856060015186608001518760a001518860c001518960e0015160405180896000191660001916815260200188600160a060020a0316600160a060020a0316815260200187600160a060020a0316600160a060020a031681526020018660ff1660ff168152602001858152602001848152602001806020018381526020018281038252848181518152602001915080519060200190808383600083146108e1575b8051825260208311156108e157601f1990920191602091820191016108c1565b505050905090810190601f16801561090d5780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390a15b50505050505050565b600081600160a060020a03166109418585611085565b600160a060020a03161490505b9392505050565b6000818152602081905260409020805482146109e457604080516020808252602a908201527f6368616e6e656c20776974682074686174206368616e6e656c496420646f6573818301527f206e6f7420657869737400000000000000000000000000000000000000000000606082015290516000805160206118508339815191529181900360800190a1610bde565b805460018083015460028085015460038601546004870154600688015460408051898152600160a060020a039788166020820181905297861691810182905260ff60a060020a90960495909516606086018190526080860185905260a0860184905260e0860183905261010060c0870181815260058d0180549b8c1615830260001901909b16989098049087018190527fa4fc3a6fe4b3ec7ba49670990463c0f8df3f35e42902ca824723de4273a12f759a9992979196929392919061012083019085908015610af55780601f10610aca57610100808354040283529160200191610af5565b820191906000526020600020905b815481529060010190602001808311610ad857829003601f168201915b5050995050505050505050505060405180910390a16000808255828152602081905260408120908155600182810154828201805473ffffffffffffffffffffffffffffffffffffffff19908116600160a060020a0393841617909155600280860180548287018054909416941693909317808355925460ff60a060020a91829004160274ff000000000000000000000000000000000000000019909316929092179055600380850154908401556004808501549084015560058085018054869594610bd3949386019390821615610100026000190190911604611705565b506006918201549101555b5050565b6000610bec6116b9565b600089815260208190526040902054891415610c7b57604080516020808252602a908201527f6368616e6e656c20776974682074686174206368616e6e656c496420616c7265818301527f6164792065786973747300000000000000000000000000000000000000000000606082015290516000805160206118508339815191529181900360800190a161107a565b6040517f6e65774368616e6e656c000000000000000000000000000000000000000000008152600a81018a90526c01000000000000000000000000600160a060020a03808b168202602a840152891602603e82015286518a918a918a918a918a9190605282019060208501908083835b60208310610d0a5780518252601f199092019160209182019101610ceb565b6001836020036101000a0380198251168184511680821785525050505050509050018281526020019550505050505060405180910390209150610d4e82858a61092b565b1515610da7576040805160208082526012908201527f7369676e61747572653020696e76616c696400000000000000000000000000008183015290516000805160206118508339815191529181900360600190a161107a565b610db282848961092b565b1515610e0b576040805160208082526012908201527f7369676e61747572653120696e76616c696400000000000000000000000000008183015290516000805160206118508339815191529181900360600190a161107a565b610100604051908101604052808a60001916815260200189600160a060020a0316815260200188600160a060020a03168152602001600060ff168152602001868152602001600081526020018781526020016000815250905080600060008b600019166000191681526020019081526020016000206000820151816000019060001916905560208201518160010160006101000a815481600160a060020a030219169083600160a060020a0316021790555060408201518160020160006101000a815481600160a060020a030219169083600160a060020a0316021790555060608201518160020160146101000a81548160ff021916908360ff1602179055506080820151816003015560a0820151816004015560c0820151816005019080519060200190610f3b92919061178b565b5060e082015181600601559050507fcfe845afd92a26dd57b921f58e710b416422395afcb2463b6af75f8e3f4bb9f5816000015182602001518360400151846060015185608001518660a001518760c001518860e0015160405180896000191660001916815260200188600160a060020a0316600160a060020a0316815260200187600160a060020a0316600160a060020a031681526020018660ff1660ff16815260200185815260200184815260200180602001838152602001828103825284818151815260200191508051906020019080838360008314611039575b80518252602083111561103957601f199092019160209182019101611019565b505050905090810190601f1680156110655780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390a15b505050505050505050565b600060006000600060006000600060019250875160411415156110a757610000565b6020880151604089015160418a015191975095509350839250601b60ff841610156110d75782601b0191506110db565b8291505b6040805160008181526020808301845291830181905282518c815260ff8616818401528084018a905260608101899052925160019360808082019493601f19840193928390039091019190866161da5a03f1151561113557fe5b50506020604051035190508096505b50505050505092915050565b6111586116b9565b600082815260208181526040918290208251610100808201855282548252600180840154600160a060020a03908116848701526002808601549182168589015260a060020a90910460ff16606085015260038501546080850152600485015460a08501526005850180548851600019948216159095029390930190921604601f81018690048602830186019096528582529194929360c0860193919291908301828280156112475780601f1061121c57610100808354040283529160200191611247565b820191906000526020600020905b81548152906001019060200180831161122a57829003601f168201915b505050505081526020016006820154815250509050600160ff16816060015160ff1614801561127957508060a0015143115b15610bde57600260608201525b5b5050565b6000600060006000600061129d61180a565b60008781526020818152604080832060018082015460028084015460038501546004860154600590960180548851601f97821615610100026000190190911694909404958601899004890284018901909752848352600160a060020a039384169e509281169c5060ff60a060020a909104169a50909850919650909283018282801561136a5780601f1061133f5761010080835404028352916020019161136a565b820191906000526020600020905b81548152906001019060200180831161134d57829003601f168201915b50505060008b81526020819052604090206006015492945091925050505b919395979092949650565b61139b6116b9565b6000848152602081815260408083208151610100808201845282548252600180840154600160a060020a03908116848801526002808601549182168588015260a060020a90910460ff16606085015260038501546080850152600485015460a08501526005850180548751600019948216159095029390930190921604601f81018790048702830187019095528482529194929360c08601939192918301828280156114885780601f1061145d57610100808354040283529160200191611488565b820191906000526020600020905b81548152906001019060200180831161146b57829003601f168201915b505050918352505060069190910154602090910152606081015190925060ff1615611500576040805160208082526010908201527f6368616e6e656c206e6f74206f70656e000000000000000000000000000000008183015290516000805160206118508339815191529181900360600190a16116b2565b50604080517f73746172744368616c6c656e6765506572696f6400000000000000000000000081526014810186905290519081900360340190206020820151600160a060020a03848116911614156115bf576115618185846020015161092b565b15156115ba576040805160208082526011908201527f7369676e617475726520696e76616c69640000000000000000000000000000008183015290516000805160206118508339815191529181900360600190a16116b2565b61169d565b8160400151600160a060020a031683600160a060020a0316141561164a576115618185846040015161092b565b15156115ba576040805160208082526011908201527f7369676e617475726520696e76616c69640000000000000000000000000000008183015290516000805160206118508339815191529181900360600190a16116b2565b61169d565b604080516020808252600e908201527f7369676e657220696e76616c69640000000000000000000000000000000000008183015290516000805160206118508339815191529181900360600190a16116b2565b5b6080820151430160a0830152600160608301525b5050505050565b6040805161010081018252600080825260208201819052918101829052606081018290526080810182905260a081019190915260c081016116f861180a565b8152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061173e578054855561177a565b8280016001018555821561177a57600052602060002091601f016020900482015b8281111561177a57825482559160010191906001019061175f565b5b5061178792915061182e565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106117cc57805160ff191683800117855561177a565b8280016001018555821561177a579182015b8281111561177a5782518255916020019190600101906117de565b5b5061178792915061182e565b5090565b60408051602081019091526000815290565b60408051602081019091526000815290565b61184c91905b808211156117875760008155600101611834565b5090565b90560008c379a0afcc32b1a39302f7cb8073359698411ab5fd6e3edb2c02c0b5fba8aaa165627a7a72305820c0c1dfcdc8ca44efac884900eef774fb9e77c6f71d7fee93eec3bd8fdb7da9120029'
const storageLocation = argv.f || path.join(__dirname, '../data/storage')
const web3Provider = argv.w || 'http://localhost:8545'


;(async () => {
  // MAKE WEB3
  const web3 = new Web3()
  const provider = new Web3.providers.HttpProvider(web3Provider)
  web3.setProvider(provider)
  const accounts = await p(web3.eth.getAccounts)()
  web3.eth.defaultAccount = accounts[0]

  // // INSTANTIATE PUDDING CONTRACT ABSTRACTION
  // const StateChannels = require(PUDDING_PATH + '/StateChannels.sol.js')
  // StateChannels.setProvider(new Web3.providers.HttpProvider(web3Provider))
  // const contract = await StateChannels.new()
  // var input = {
    // 'ECVerify.sol': fs.readFileSync('./contracts/ECVerify.sol').toString(),
    // 'StateChannels.sol': fs.readFileSync('./contracts/StateChannels.sol').toString()
    // 'StateChannels2.sol': fs.readFileSync('./contracts/StateChannels2.sol').toString()
  // }

  // var output = solc.compile(fs.readFileSync('./contracts/StateChannels2.sol').toString(), 1)
  // if (output.errors) { throw new Error(output.errors) }

  var StateChannels = Contract({
    abi: abi,
    address: contractAddress,
    network_id: 3,
    networks: [3],
    binary: bytecode
  })
  // var StateChannels = Contract(abi)
  StateChannels.setProvider(provider)
  StateChannels.setDefaultAccount(accounts[0])
  // await StateChannels.detectNetwork()

  // var contract = await StateChannels.new()
  var contract = await StateChannels.deployed()
  console.log(`contract address: ${contract.address}, network: ${StateChannels.hasNetwork(3)}`)

  var JSONStorage = require('node-localstorage').JSONStorage
  var storage = new JSONStorage(storageLocation)

  const post = p(function (url, body, callback) {
    request.post({
      url,
      body,
      json: true,
    }, callback)
  })

  var globals = {
    storage,
    contract,
    web3,
    post
  }

  var caller = require('./servers/caller.js').default(globals)
  var peer = require('./servers/peer.js').default(globals)

  peer.listen(peerPort, () => console.log('peer api listening on ' + peerPort))
  caller.listen(callerPort, () => console.log('caller api listening on ' + callerPort))
})().catch(err => console.error(err))
